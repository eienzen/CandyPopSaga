<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://api.phonepe.com; style-src 'self' 'unsafe-inline'; media-src 'self'; img-src 'self' data:; connect-src 'self' https://api.phonepe.com; worker-src 'self' blob: https://cdnjs.cloudflare.com;">
  <title>Candy Pop Saga</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <style>
    body {
      margin: 0;
      background: linear-gradient(135deg, #ff99cc 0%, #66ccff 100%);
      font-family: 'Bubblegum Sans', cursive;
      text-align: center;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('sounds/candy-overlay.png') repeat;
      opacity: 0.1;
      z-index: -1;
    }
    #header {
      background: url('sounds/candy-background.jpg') no-repeat center;
      background-size: cover;
      height: 120px;
      color: #ffffff;
      font-size: 48px;
      line-height: 120px;
      text-shadow: 3px 3px #ff3366;
    }
    #footer {
      background: #ff66b3;
      color: #ffffff;
      padding: 15px;
      position: fixed;
      bottom: 0;
      width: 100%;
      font-size: 16px;
    }
    canvas {
      display: block;
      margin: 20px auto;
      border: 8px solid #ff99cc;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    #referral {
      margin: 20px;
      font-size: 24px;
      color: #ff3366;
      text-shadow: 1px 1px #ffffff;
    }
    .loading-text {
      color: #ff3366;
      font-size: 24px;
      margin-top: 20px;
      text-shadow: 1px 1px #ffffff;
    }
    #boosterButton, #buyBooster {
      position: absolute;
      top: 150px;
      right: 20px;
      background-color: #ff3366;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
      margin-top: 10px;
    }
    #leaderboard {
      position: absolute;
      top: 200px;
      right: 20px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 16px;
      color: #ff3366;
    }
  </style>
</head>
<body>
  <div id="header">Candy Pop Saga</div>
  <div id="referral">रेफरल कोड: <span id="refCode"></span> | दोस्तों को आमंत्रित करें और बोनस पॉइंट्स जीतें! <input type="text" id="referralInput" placeholder="रेफरल कोड डालें" onkeyup="checkReferral(event)"></div>
  <div class="loading-text">Loading...</div>
  <button id="boosterButton" onclick="useBooster()">Clear Row Booster (500 Points)</button>
  <button id="buyBooster" onclick="buyBooster()">500 स्कोर वाला बूस्टर खरीदें (₹10)</button>
  <div id="leaderboard">
    <h3>लीडरबोर्ड</h3>
    <div id="leaderboardList"></div>
  </div>
  <div id="footer">© 2025 Candy Pop Saga | खेलें और मज़े करें!</div>
  <script>
    let candies = [];
    let board = [];
    let score = 0;
    let moves = 20;
    let level = 1;
    let targetScore = 1000;
    let selectedCandy = null;
    let referralCode = generateReferralCode();
    let particles = [];
    let startSound, victorySound, gameOverSound;
    let candyTextures = [];
    let isLoaded = false;
    let gridSize = 8;
    let candyTypes = 4;
    let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
    let referredBy = localStorage.getItem('referredBy') || '';

    if (referredBy) {
      score += 100;
      alert('रेफरल बोनस! 100 स्कोर जोड़ा गया।');
    }

    function preload() {
      startSound = loadSound('sounds/start game sound-effect.mp3', () => console.log('Start sound loaded'), (err) => console.error('Failed to load start sound:', err));
      victorySound = loadSound('sounds/victory-sound-101319.mp3', () => console.log('Victory sound loaded'), (err) => console.error('Failed to load victory sound:', err));
      gameOverSound = loadSound('sounds/game-over-arcade-6435.mp3', () => console.log('Game over sound loaded'), (err) => console.error('Failed to load game over sound:', err));
      candyTextures[0] = loadImage('sounds/candy-red.png', () => console.log('Red candy loaded'), (err) => console.error('Failed to load red candy:', err));
      candyTextures[1] = loadImage('sounds/candy-green.png', () => console.log('Green candy loaded'), (err) => console.error('Failed to load green candy:', err));
      candyTextures[2] = loadImage('sounds/candy-blue.png', () => console.log('Blue candy loaded'), (err) => console.error('Failed to load blue candy:', err));
      candyTextures[3] = loadImage('sounds/candy-yellow.png', () => console.log('Yellow candy loaded'), (err) => console.error('Failed to load yellow candy:', err));
    }

    function setup() {
      if (!startSound || !victorySound || !gameOverSound || !candyTextures[0] || !candyTextures[1] || !candyTextures[2] || !candyTextures[3]) {
        console.error('One or more resources failed to load:', { startSound, victorySound, gameOverSound, candyTextures });
        candyTextures[0] = createGraphics(32, 32); candyTextures[0].background(255, 0, 0);
        candyTextures[1] = createGraphics(32, 32); candyTextures[1].background(0, 255, 0);
        candyTextures[2] = createGraphics(32, 32); candyTextures[2].background(0, 0, 255);
        candyTextures[3] = createGraphics(32, 32); candyTextures[3].background(255, 255, 0);
      }
      createCanvas(450, 450, WEBGL);
      frameRate(30);
      textFont('Bubblegum Sans');
      initializeGame();
      if (startSound) startSound.play();
      document.getElementById('refCode').innerText = referralCode;
      document.querySelector('.loading-text').style.display = 'none';
      isLoaded = true;
      updateLeaderboard();
    }

    function initializeGame() {
      if (level >= 5) gridSize = 10;
      else gridSize = 8;
      if (level >= 3) candyTypes = 5;
      if (level >= 5) candyTypes = 6;

      board = [];
      candies = [];
      for (let i = 0; i < gridSize; i++) {
        board[i] = [];
        for (let j = 0; j < gridSize; j++) {
          board[i][j] = floor(random(candyTypes));
          candies.push({ x: i, y: j, type: board[i][j], scale: 1, matched: false });
        }
      }
    }

    function drawBoard() {
      for (let candy of candies) {
        if (candy.matched) continue;
        push();
        translate((candy.x - gridSize / 2) * 50 + 25, (candy.y - gridSize / 2) * 50 + 25, 0);
        scale(candy.scale);
        rotateX(frameCount * 0.01);
        rotateY(frameCount * 0.01);
        texture(candyTextures[candy.type % 4]);
        sphere(20, 16, 16);
        pop();
      }
      for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        push();
        translate((p.x - gridSize / 2) * 50 + 25, (p.y - gridSize / 2) * 50 + 25, 0);
        fill(255, 255, 0, p.alpha);
        sphere(5);
        pop();
        p.y += p.vy;
        p.alpha -= 5;
        if (p.alpha <= 0) particles.splice(i, 1);
      }
    }

    function displayStats() {
      push();
      translate(-200, -200, 0);
      fill(255);
      textSize(20);
      text(`स्कोर: ${score}`, 10, 30);
      text(`चालें: ${moves}`, 10, 60);
      text(`लेवल: ${level}`, 10, 90);
      text(`लक्ष्य: ${targetScore}`, 10, 120);
      pop();
    }

    function handleGameState() {
      if (score >= targetScore) {
        level++;
        targetScore += 500;
        moves = 20;
        score = 0;
        if (victorySound) victorySound.play();
        alert('लेवल पूरा! अगला लेवल शुरू!');
        initializeGame();
      }
      if (moves <= 0 && score < targetScore) {
        if (gameOverSound) gameOverSound.play();
        addToLeaderboard(score);
        alert('गेम ओवर! फिर से शुरू करें।');
        resetGame();
      }
    }

    function handleMousePress(mx, my) {
      let x = floor((mx - width / 2) / 50 + gridSize / 2);
      let y = floor((my - height / 2) / 50 + gridSize / 2);
      if (x >= 0 && x < gridSize && y >= 0 && y < gridSize) {
        if (!selectedCandy) {
          selectedCandy = { x, y };
          candies.find(c => c.x === x && c.y === y).scale = 1.2;
        } else {
          if (abs(selectedCandy.x - x) + abs(selectedCandy.y - y) === 1) {
            swapCandies(selectedCandy.x, selectedCandy.y, x, y);
            if (checkMatches()) {
              moves--;
            } else {
              swapCandies(selectedCandy.x, selectedCandy.y, x, y);
            }
          }
          candies.find(c => c.x === selectedCandy.x && c.y === selectedCandy.y).scale = 1;
          selectedCandy = null;
        }
      }
    }

    function swapCandies(x1, y1, x2, y2) {
      let temp = board[x1][y1];
      board[x1][y1] = board[x2][y2];
      board[x2][y2] = temp;
      updateCandies();
    }

    function checkMatches() {
      let matches = false;
      for (let i = 0; i < gridSize; i++) {
        for (let j = 0; j < gridSize - 2; j++) {
          if (board[i][j] === board[i][j + 1] && board[i][j] === board[i][j + 2]) {
            matches = true;
            score += 100;
            board[i][j] = board[i][j + 1] = board[i][j + 2] = -1;
            createParticles(i, j);
            createParticles(i, j + 1);
            createParticles(i, j + 2);
          }
        }
      }
      for (let j = 0; j < gridSize; j++) {
        for (let i = 0; i < gridSize - 2; i++) {
          if (board[i][j] === board[i + 1][j] && board[i][j] === board[i + 2][j]) {
            matches = true;
            score += 100;
            board[i][j] = board[i + 1][j] = board[i + 2][j] = -1;
            createParticles(i, j);
            createParticles(i + 1, j);
            createParticles(i + 2, j);
          }
        }
      }
      if (matches) {
        clearMatches();
      }
      return matches;
    }

    function createParticles(x, y) {
      for (let i = 0; i < 5; i++) {
        particles.push({
          x: x,
          y: y,
          vy: random(-2, -1),
          alpha: 255
        });
      }
    }

    function clearMatches() {
      for (let i = 0; i < gridSize; i++) {
        for (let j = 0; j < gridSize; j++) {
          if (board[i][j] === -1) {
            for (let k = j; k > 0; k--) {
              board[i][k] = board[i][k - 1];
            }
            board[i][0] = floor(random(candyTypes));
          }
        }
      }
      updateCandies();
    }

    function updateCandies() {
      candies = [];
      for (let i = 0; i < gridSize; i++) {
        for (let j = 0; j < gridSize; j++) {
          candies.push({ x: i, y: j, type: board[i][j], scale: 1, matched: board[i][j] === -1 });
        }
      }
    }

    function resetGame() {
      score = 0;
      moves = 20;
      level = 1;
      targetScore = 1000;
      particles = [];
      initializeGame();
      if (startSound) startSound.play();
    }

    function generateReferralCode() {
      return 'CANDY' + Math.floor(Math.random() * 10000);
    }

    function useBooster() {
      if (score >= 500) {
        score -= 500;
        let row = floor(random(gridSize));
        for (let j = 0; j < gridSize; j++) {
          board[row][j] = -1;
          createParticles(row, j);
        }
        score += 200;
        clearMatches();
      } else {
        alert('बूस्टर के लिए 500 स्कोर चाहिए!');
      }
    }

    function buyBooster() {
      fetch('https://api.phonepe.com/v4/transaction', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-VERIFY': 'YOUR_SIGNATURE', // PhonePe API के लिए सिग्नेचर
          'X-MERCHANT-ID': 'YOUR_MERCHANT_ID'
        },
        body: JSON.stringify({
          "merchantId": "YOUR_MERCHANT_ID",
          "merchantTransactionId": "TXN" + Date.now(),
          "merchantUserId": "USER" + referralCode,
          "amount": 1000, // ₹10 in paise
          "redirectUrl": "https://eienzen.github.io/CandyPopSaga/callback.html",
          "redirectMode": "REDIRECT",
          "callbackUrl": "https://eienzen.github.io/CandyPopSaga/callback.html",
          "mobileNumber": "9999999999",
          "paymentInstrument": {
            "type": "PAY_PAGE"
          }
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = data.data.instrumentResponse.redirectInfo.url; // PhonePe पेमेंट पेज पर रीडायरेक्ट करें
        } else {
          alert('पेमेंट रिक्वेस्ट विफल!');
        }
      })
      .catch(err => {
        console.error('PhonePe पेमेंट त्रुटि:', err);
        alert('पेमेंट रिक्वेस्ट में त्रुटि!');
      });
    }

    function addToLeaderboard(newScore) {
      leaderboard.push(newScore);
      leaderboard.sort((a, b) => b - a);
      leaderboard = leaderboard.slice(0, 5);
      localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
      updateLeaderboard();
    }

    function updateLeaderboard() {
      let list = document.getElementById('leaderboardList');
      list.innerHTML = '';
      leaderboard.forEach((score, index) => {
        list.innerHTML += `<div>${index + 1}. ${score}</div>`;
      });
    }

    function checkReferral(event) {
      if (event.key === 'Enter' && event.target.value === referralCode) {
        score += 100;
        localStorage.setItem('referredBy', referralCode);
        alert('रेफरल सफल! 100 स्कोर जोड़ा गया।');
        event.target.value = '';
      }
    }

    function draw() {
      if (!isLoaded) return;
      background(255, 220, 230);
      ambientLight(150);
      pointLight(255, 255, 255, 0, 0, 200);
      drawBoard();
      displayStats();
      handleGameState();
    }

    function mousePressed() {
      if (!isLoaded) return;
      handleMousePress(mouseX, mouseY);
    }
  </script>
</body>
</html>
