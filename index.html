<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://raw.githubusercontent.com; style-src 'self' 'unsafe-inline'; media-src 'self' https://raw.githubusercontent.com; img-src 'self' https://raw.githubusercontent.com; connect-src 'self' https://raw.githubusercontent.com; worker-src 'self' blob: https://cdnjs.cloudflare.com;">
  <title>Candy Pop Saga</title>
  <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <script src="game.js"></script>
  <style>
    body {
      margin: 0;
      background: linear-gradient(135deg, #ff99cc 0%, #66ccff 100%);
      font-family: 'Bubblegum Sans', cursive;
      text-align: center;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/candy-overlay.png') repeat;
      opacity: 0.1;
      z-index: -1;
    }
    #header {
      background: url('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/candy-background.jpg') no-repeat center;
      background-size: cover;
      height: 120px;
      color: #ffffff;
      font-size: 48px;
      line-height: 120px;
      text-shadow: 3px 3px #ff3366;
    }
    #footer {
      background: #ff66b3;
      color: #ffffff;
      padding: 15px;
      position: fixed;
      bottom: 0;
      width: 100%;
      font-size: 16px;
    }
    canvas {
      display: block;
      margin: 20px auto;
      border: 8px solid #ff99cc;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    #referral {
      margin: 20px;
      font-size: 24px;
      color: #ff3366;
      text-shadow: 1px 1px #ffffff;
    }
    .loading-text {
      color: #ff3366;
      font-size: 24px;
      margin-top: 20px;
      text-shadow: 1px 1px #ffffff;
    }
  </style>
</head>
<body>
  <div id="header">Candy Pop Saga</div>
  <div id="referral">रेफरल कोड: <span id="refCode"></span> | दोस्तों को आमंत्रित करें और बोनस पॉइंट्स जीतें!</div>
  <div class="loading-text">Loading...</div>
  <div id="footer">© 2025 Candy Pop Saga | खेलें और मज़े करें!</div>
  <script>
    let startSound, victorySound, gameOverSound;
    let candyTextures = [];
    let isLoaded = false;

    function preload() {
      startSound = loadSound('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/start%20game%20sound-effect.mp3', () => console.log('Start sound loaded'), (err) => console.error('Failed to load start sound:', err));
      victorySound = loadSound('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/victory-sound-101319.mp3', () => console.log('Victory sound loaded'), (err) => console.error('Failed to load victory sound:', err));
      gameOverSound = loadSound('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/game-over-arcade-6435.mp3', () => console.log('Game over sound loaded'), (err) => console.error('Failed to load game over sound:', err));
      candyTextures[0] = loadImage('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/candy-red.png', () => console.log('Red candy loaded'), (err) => console.error('Failed to load red candy:', err));
      candyTextures[1] = loadImage('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/candy-green.png', () => console.log('Green candy loaded'), (err) => console.error('Failed to load green candy:', err));
      candyTextures[2] = loadImage('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/candy-blue.png', () => console.log('Blue candy loaded'), (err) => console.error('Failed to load blue candy:', err));
      candyTextures[3] = loadImage('https://raw.githubusercontent.com/eienzen/CandyPopSaga/main/sounds/candy-yellow.png', () => console.log('Yellow candy loaded'), (err) => console.error('Failed to load yellow candy:', err));
    }

    function setup() {
      if (!startSound || !victorySound || !gameOverSound || !candyTextures[0] || !candyTextures[1] || !candyTextures[2] || !candyTextures[3]) {
        console.error('One or more resources failed to load:', { startSound, victorySound, gameOverSound, candyTextures });
        // Fallback: Use default colors if images fail
        candyTextures[0] = createGraphics(32, 32); candyTextures[0].background(255, 0, 0);
        candyTextures[1] = createGraphics(32, 32); candyTextures[1].background(0, 255, 0);
        candyTextures[2] = createGraphics(32, 32); candyTextures[2].background(0, 0, 255);
        candyTextures[3] = createGraphics(32, 32); candyTextures[3].background(255, 255, 0);
      }
      createCanvas(450, 450, WEBGL);
      frameRate(30);
      textFont('Bubblegum Sans');
      initializeGame();
      if (startSound) startSound.play();
      document.getElementById('refCode').innerText = referralCode;
      document.querySelector('.loading-text').style.display = 'none';
      isLoaded = true;
    }

    function draw() {
      if (!isLoaded) return;
      background(255, 220, 230);
      ambientLight(150);
      pointLight(255, 255, 255, 0, 0, 200);
      drawBoard();
      displayStats();
      handleGameState();
    }

    function mousePressed() {
      if (!isLoaded) return;
      handleMousePress(mouseX, mouseY);
    }
  </script>
</body>
</html>
